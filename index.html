<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI College Helpdesk Chatbot</title>
<style>
    :root {
        --primary: #0d47a1;
        --secondary: #90caf9;
        --bg: #f0f4fb;
        --text: #333;
        --card: #ffffff;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        transition: 0.3s;
    }

    .dark-mode {
        --bg: #1a1a1a;
        --text: #f0f0f0;
        --card: #2d2d2d;
        --primary: #1565c0;
        background: #121212;
    }

    .chat-container {
        width: 480px;
        max-width: 95%;
        height: 90vh;
        background: var(--card);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .chat-header {
        background: var(--primary);
        color: white;
        padding: 15px;
        text-align: center;
        font-size: 18px;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .header-btns button {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
        margin-left: 5px;
    }

    .api-setup {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .api-setup.active {
        display: flex;
    }

    .api-modal {
        background: var(--card);
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        width: 90%;
        max-width: 500px;
    }

    .api-modal h2 {
        color: var(--primary);
        margin-top: 0;
    }

    .api-modal input {
        width: 100%;
        padding: 12px;
        margin: 10px 0 20px;
        border: 2px solid var(--secondary);
        border-radius: 8px;
        box-sizing: border-box;
        font-size: 14px;
    }

    .api-modal button {
        background: var(--primary);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        width: 100%;
    }

    .api-modal button:hover {
        background: #0b3d91;
    }

    .api-info {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
        font-size: 13px;
        line-height: 1.6;
    }

    .api-info a {
        color: #0d47a1;
        font-weight: bold;
    }

    .chat-box {
        flex-grow: 1;
        padding: 15px;
        overflow-y: auto;
        background: var(--bg);
        scroll-behavior: smooth;
    }

    .bot-message, .user-message {
        padding: 12px 16px;
        border-radius: 15px;
        margin-bottom: 12px;
        max-width: 80%;
        font-size: 14px;
        line-height: 1.5;
        animation: fadeIn 0.4s ease;
        word-wrap: break-word;
    }

    .bot-message { 
        background: var(--card); 
        color: var(--text); 
        box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
        border-bottom-left-radius: 2px; 
    }
    
    .user-message { 
        background: var(--primary); 
        color: white; 
        margin-left: auto; 
        border-bottom-right-radius: 2px; 
    }

    .timestamp {
        font-size: 10px;
        text-align: right;
        margin-top: 4px;
        opacity: 0.6;
    }

    .quick-btns {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        padding: 10px;
        background: var(--bg);
        border-top: 1px solid rgba(0,0,0,0.05);
    }

    .quick-btns button {
        font-size: 12px;
        border: none;
        padding: 8px 12px;
        border-radius: 20px;
        background: var(--secondary);
        color: #0d47a1;
        cursor: pointer;
        transition: 0.2s;
        font-weight: 600;
    }

    .quick-btns button:hover { 
        background: var(--primary); 
        color: white; 
    }

    .chat-input { 
        display: flex; 
        padding: 10px; 
        background: var(--card); 
        border-top: 1px solid #ddd; 
    }
    
    .chat-input input { 
        flex: 1; 
        padding: 12px; 
        border: 1px solid #ddd; 
        border-radius: 25px; 
        outline: none; 
        padding-left: 20px; 
    }
    
    .chat-input button { 
        background: var(--primary); 
        color: white; 
        border: none; 
        width: 45px; 
        height: 45px; 
        border-radius: 50%; 
        margin-left: 10px; 
        cursor: pointer; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        font-size: 20px;
    }

    .error-msg {
        background: #f8d7da;
        color: #721c24;
        padding: 10px;
        border-radius: 5px;
        border-left: 4px solid #f5c6cb;
    }

    @keyframes fadeIn { 
        from { opacity: 0; transform: translateY(5px); } 
        to { opacity: 1; transform: translateY(0); } 
    }
</style>
</head>
<body>

<div class="api-setup" id="apiSetup">
    <div class="api-modal">
        <h2>üîë Setup Gemini API</h2>
        <div class="api-info">
            <strong>Get your FREE API key in 2 minutes:</strong><br>
            1. Go to <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a><br>
            2. Click "Create API Key" ‚Üí "Create API key in new project"<br>
            3. Copy the key and paste below
        </div>
        <input type="password" id="apiKeyInput" placeholder="Paste your Gemini API key here">
        <button onclick="saveApiKey()">‚úì Connect & Start</button>
        <p style="text-align: center; font-size: 12px; color: #666; margin-top: 15px;">
            üîí Your API key is stored locally and never shared
        </p>
    </div>
</div>

<div class="chat-container">
    <div class="chat-header">
        <span>üéì College AI Helpdesk</span>
        <div class="header-btns">
            <button onclick="toggleDarkMode()" id="themeBtn">üåô</button>
            <button onclick="clearChat()">üóëÔ∏è</button>
        </div>
    </div>

    <div class="chat-box" id="chatBox">
        <div class="bot-message">
            <b>Welcome!</b> üëã<br>
            I'm powered by Google Gemini AI. Ask me anything about college!
            <div style="margin-top: 10px; font-size: 12px; opacity: 0.8;">
                üí° Try: "What's the anti-ragging policy?" or "How do I pay fees?"
            </div>
        </div>
    </div>

    <div class="quick-btns" id="faqSection">
        <button onclick="quickAsk('What is the anti-ragging policy?')">üö® Anti-Ragging</button>
        <button onclick="quickAsk('What are the office hours?')">üïí Hours</button>
        <button onclick="quickAsk('How do I contact the HOD?')">üë®‚Äçüè´ HOD</button>
        <button onclick="quickAsk('How to pay fees?')">üí∞ Fees</button>
        <button onclick="quickAsk('When are exams?')">üìÖ Exams</button>
    </div>

    <div class="chat-input">
        <input type="text" id="userInput" placeholder="Ask something..." autocomplete="off">
        <button onclick="sendMessage()">‚û§</button>
    </div>
</div>

<script>
    const chatBox = document.getElementById("chatBox");
    const userInput = document.getElementById("userInput");
    const apiSetup = document.getElementById("apiSetup");
    let apiKey = null;

    // Check for stored API key on load
    window.addEventListener("load", () => {
        apiKey = localStorage.getItem("gemini_api_key");
        if (!apiKey) {
            apiSetup.classList.add("active");
        } else {
            apiSetup.classList.remove("active");
        }
        
        // Load dark mode preference
        if (localStorage.getItem("darkMode") === "true") {
            document.body.classList.add('dark-mode');
            document.getElementById("themeBtn").innerText = "‚òÄÔ∏è";
        }
    });

    function saveApiKey() {
        const key = document.getElementById("apiKeyInput").value.trim();
        if (!key) {
            alert("Please paste your API key");
            return;
        }
        if (key.length < 20) {
            alert("API key looks too short. Please check and try again.");
            return;
        }
        localStorage.setItem("gemini_api_key", key);
        apiKey = key;
        apiSetup.classList.remove("active");
        chatBox.innerHTML = `<div class="bot-message"><b>Connected!</b> üéâ<br>Gemini API is ready. Ask me anything!</div>`;
    }

    userInput.addEventListener("keypress", (e) => { 
        if (e.key === "Enter") sendMessage(); 
    });

    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        document.getElementById("themeBtn").innerText = isDark ? "‚òÄÔ∏è" : "üåô";
        localStorage.setItem("darkMode", isDark);
    }

    function clearChat() {
        chatBox.innerHTML = `<div class="bot-message">Chat cleared! How can I help? üëã</div>`;
    }

    function timeNow() {
        return new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }

    function quickAsk(text) {
        userInput.value = text;
        sendMessage();
    }

    function sendMessage() {
        const msg = userInput.value.trim();
        if (!msg) return;

        if (!apiKey) {
            apiSetup.classList.add("active");
            return;
        }

        // Add user message
        chatBox.innerHTML += `<div class="user-message">${escapeHtml(msg)}<div class="timestamp">${timeNow()}</div></div>`;
        userInput.value = "";
        
        // Show typing indicator
        const typing = document.createElement("div");
        typing.className = "bot-message";
        typing.id = "typing";
        typing.innerHTML = "<i>‚ú® Thinking...</i>";
        chatBox.appendChild(typing);
        chatBox.scrollTop = chatBox.scrollHeight;

        // Call Gemini API
        callGeminiAPI(msg);
    }

    async function callGeminiAPI(userMessage) {
        try {
            const response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`,
                {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `You are a helpful college helpdesk assistant. Answer questions about college policies, academics, fees, exams, and campus information. Keep answers concise and friendly.\n\nUser: ${userMessage}`
                            }]
                        }]
                    })
                }
            );

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || "API Error");
            }

            const data = await response.json();
            const botReply = data.candidates?.[0]?.content?.parts?.[0]?.text || "No response generated";
            
            // Remove typing indicator
            const typing = document.getElementById("typing");
            if (typing) typing.remove();

            // Add bot response
            chatBox.innerHTML += `<div class="bot-message">${escapeHtml(botReply).replace(/\n/g, '<br>')}<div class="timestamp">${timeNow()}</div></div>`;
            chatBox.scrollTop = chatBox.scrollHeight;

        } catch (error) {
            const typing = document.getElementById("typing");
            if (typing) typing.remove();

            let errorMsg = "‚ùå Error: " + error.message;
            
            if (error.message.includes("API key")) {
                errorMsg = "‚ùå Invalid API key. Please check and try again.";
                localStorage.removeItem("gemini_api_key");
                setTimeout(() => apiSetup.classList.add("active"), 1000);
            }

            chatBox.innerHTML += `<div class="bot-message"><div class="error-msg">${errorMsg}</div></div>`;
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    }

    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }
</script>

</body>
</html>